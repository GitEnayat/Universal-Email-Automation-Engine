/**
 * Main entry point for generating email drafts.
 * Handles template retrieval, recipient resolution, and Gmail draft management.
 * * @param {string} templateName - The name of the tab in the Google Doc template.
 * @param {Object} [options] - Optional overrides.
 * @param {string} [options.docId] - Override the default Template Doc ID.
 */
function createReportDraft(templateName, options = {}) {
  // 1. Initialize Configuration
  const activeDocId = options.docId || TEMPLATE_DOC_ID;
  Logger.log(`Initializing draft generation: "${templateName}" using source: ${activeDocId}`);

  // 2. Retrieve and Parse Template
  const template = getTemplate(templateName, activeDocId);
  if (!template) {
    Logger.error(`Process aborted: Template "${templateName}" not found in document.`);
    return;
  }

  // 3. Resolve Recipients and Identity
  const toKeys = parseDistroKeys(template.to);
  const ccKeys = parseDistroKeys(template.cc);
  
  const recipientsTo = toKeys.length > 0 ? getDistroEmails(...toKeys).join(",") : "";
  const recipientsCc = ccKeys.length > 0 ? getDistroEmails(...ccKeys).join(",") : "";
  
  const signature = getUserGmailSignature();
  const emailContent = `${template.body}<br><br>${signature.html}`;

  /**
   * DRAFT RECYCLING LOGIC
   * Prevents duplicate drafts by updating an existing one if the subject matches.
   */
  try {
    const existingDrafts = GmailApp.search(`in:drafts subject:"${template.subject}"`);
    for (const thread of existingDrafts) {
      const draftMessage = thread.getMessages().find(m => m.isDraft());
      if (!draftMessage) continue;

      const isMatch = thread.getFirstMessageSubject() === template.subject || 
                      draftMessage.getSubject() === template.subject;

      if (isMatch) {
        Logger.log(`Existing draft identified for "${template.subject}". Updating content...`);
        const draft = GmailApp.getDraft(draftMessage.getId());
        draft.update(recipientsTo, template.subject, "", {
          htmlBody: emailContent,
          cc: recipientsCc
        });
        Logger.log("Draft update complete.");
        return; 
      }
    }
  } catch (err) {
    Logger.log(`Draft recycling skipped: ${err.message}`);
  }

  /**
   * THREADING & CREATION LOGIC
   * Attempts to find a relevant thread to reply to, otherwise creates a new one.
   */
  const threads = GmailApp.search(`subject:"${template.subject}"`, 0, 5);
  let targetThread = null;

  for (const thread of threads) {
    const subject = thread.getFirstMessageSubject();
    // Ignore automated replies/Out of Office notifications
    if (subject.match(/^(Automatic reply|OOO|Out of Office|Absence Notice):/i)) continue;
    targetThread = thread;
    break;
  }

  if (targetThread) {
    targetThread.createDraftReplyAll("", {
      htmlBody: emailContent,
      cc: recipientsCc
    });
    Logger.log("Draft created as a reply to an existing thread.");
  } else {
    GmailApp.createDraft(recipientsTo, template.subject, "", {
      cc: recipientsCc,
      htmlBody: emailContent
    });
    Logger.log("New draft created successfully.");
  }
}
